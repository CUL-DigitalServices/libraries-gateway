/*!
 * Copyright 2014 Digital Services, University of Cambridge Licensed
 * under the Educational Community License, Version 2.0 (the
 * "License"); you may not use this file except in compliance with the
 * License. You may obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var _ = require('underscore');
var request = require('request');
var q = require('q');
var querystring = require('querystring');

var config = require('../../../config');
var log = require('lg-util/lib/logger').logger();

var Tweet = require('./model').Tweet;

var _access_token = null;
var _lastUpdated = null;
var _tweets = null;

////////////////////////
//  PUBLIC FUNCTIONS  //
////////////////////////

/**
 * Function that fetches the tweets from the libraries
 */
var getTweets = module.exports.getTweets = function() {
    var deferred = q.defer();

    /*!
     * Function that gets iterated if necessary, depending on the expiry date and authentication status on Twitter
     */
    var _getTweets = function() {

        // Return the cached tweets if not expired
        if (!_getTweetsExpired()) {
            return deferred.resolve(_tweets);

        // First check if we need to authenticate before fetching the tweets
        } else if (!_getAccessToken()) {
            log().info('Authenticating to Twitter API');

            // Authenticate user before requesting tweets
            _authenticate()

                // Request the tweets from the Twitter API
                .then(function() {
                    _getTweets();
                })

                // Reject the promise if an error is thrown
                .catch(errorHandler);

        // Request the tweets if the client has been authenticated
        } else {

            // Request the Tweets from the Twitter API
            _requestTweets()

                // Resolve the promise by returning the tweets
                .then(function(tweets) {
                    _lastUpdated = Date.now();
                    _tweets = tweets;
                    return deferred.resolve(_tweets);
                })

                // Reject the promise if an error is thrown
                .catch(errorHandler);
        }
    };

    /*!
     * Rejects the promise and returns the error object
     */
    var errorHandler = function(err) {
        deferred.reject(err);
    }

    // Request the tweets
    _getTweets();

    // Return a promise
    return deferred.promise;
};

//////////////////////////
//  INTERNAL FUNCTIONS  //
//////////////////////////

/**
 * Function that requests a Twitter access token
 *
 * @api private
 */
var _authenticate = function(callback) {
    var deferred = q.defer();

    // Authentication credentials
    var consumer_key = config.secret.twitter.consumer_key;
    var consumer_secret = config.secret.twitter.consumer_secret;

    // Create a credentials hash
    var credentials = _getCredentialsBase64(consumer_key, consumer_secret);

    // Request options
    var options = {
        'method': 'POST',
        'timeout': config.nodes.home.settings.twitter.timeout,
        'url': 'https://api.twitter.com/oauth2/token',
        'body': querystring.stringify({'grant_type': 'client_credentials'}),
        'headers': {
            'Authorization': 'Basic ' + credentials,
            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
        }
    };

    // Send a token request to the Twitter API
    request(options, function(err, response, body) {
        if (err) {
            log().error({'code': 400, 'msg': err}, 'Error while authenticating on Twitter');
            return deferred.reject({'code': 400, 'msg': 'Error while authenticating on Twitter'});
        }

        try {

            // Parse the response body
            var body = JSON.parse(body);
            if (body.errors) {
                log().error({'code': 400, 'msg': body.errors}, 'Error while authenticating on Twitter');
                return deferred.reject({'code': 400, 'msg': 'Error while authenticating on Twitter'});
            }

            // Set the Twitter access token
            _setAccessToken(body.access_token);

            // Resolve the promise
            return deferred.resolve();

        } catch(err) {
            log().error({'code': 400, 'msg': err}, 'Error while authenticating on Twitter');
            return deferred.reject({'code': 400, 'msg': 'Error while authenticating on Twitter'});
        }
    });

    // Return a promise
    return deferred.promise;
};

/**
 * Function that encodes the authentication credentials
 *
 * @param  {String}  key       The Twitter consumer key
 * @param  {String}  secret    The Twitter consumer secret
 * @return {Buffer}            The hashed authenticaton credentials
 * @api private
 */
var _getCredentialsBase64 = function(key, secret) {
    return new Buffer(encodeURI(key) + ':' + encodeURI(secret)).toString('base64');
};

/**
 * Function that fetches the tweets form the Twitter API
 *
 * @api private
 */
var _requestTweets = function() {
    var deferred = q.defer();

    var bodyParams = {
        'slug': 'cam-uni-libraries',
        'owner_screen_name': 'libatcam',
        'count': 8
    };

    // Request options
    var options = {
        'method': 'GET',
        'timeout': config.nodes.home.settings.twitter.timeout,
        'url': 'https://api.twitter.com/1.1//lists/statuses.json?' + querystring.stringify(bodyParams),
        'headers': {
            'Authorization': 'Bearer ' + _getAccessToken()
        }
    };

    // Send a tweet request to the Twitter API
    request(options, function(err, response, body) {
        if (err) {
            log().error({'code': 500, 'msg': err}, 'Error while requesting tweets from Twitter API');
            return deferred.reject({'code': 500, 'msg': 'Error while requesting tweets from Twitter API'});
        }

        try {

            // Parse the response body
            var body = JSON.parse(body);
            var tweets = _.map(body, function(tweet) {
                return _createTweetModel(tweet);
            });

            // Return the tweet collection
            return deferred.resolve(tweets);

        } catch(err) {
            log().error({'code': 500, 'msg': err}, 'Error while parsing tweets');
            return deferred.reject({'code': 500, 'msg': 'Error while parsing tweets'});
        }
    });

    // Return a promise
    return deferred.promise;
};

/**
 * Function that creates a new tweet model per record
 *
 * @param  {Object}     record      Object containing raw tweet data
 * @return {Tweet}                  The returned tweet model
 * @api private
 */
var _createTweetModel = function(record) {

    // Pick the properties out of the record
    var name = record.user.name;
    var screen_name = record.user.screen_name;
    var created_at = record.created_at;
    var text = record.text;

    // Return a tweet model
    return new Tweet(name, screen_name, created_at, text);
};

/**
 * Returns true if the tweets need to be refetched
 *
 * @return {Boolean}    Whether or not the tweets need to be refetched
 * @api private
 */
var _getTweetsExpired = function() {
    var now = Date.now();
    var lifeTime = config.nodes.home.settings.twitter.tweet_expiration;
    return (!_lastUpdated || now - _lastUpdated > lifeTime);
};

/**
 * Getter for the Twitter access token
 *
 * @return {String}     The Twitter access token
 * @api private
 */
var _getAccessToken = function() {
    return _access_token;
};

/**
 * Setter for the Twitter access token
 *
 * @param  {String}     access_token    The Twitter access token
 * @api private
 */
var _setAccessToken = function(access_token) {
    _access_token = access_token;
};
